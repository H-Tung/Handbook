# 20.3. zpool 管理

ZFS管理使用两个主要的实用程序。`zpool`工具控制池的操作，允许添加、删除、替换和管理磁盘。[zfs](https://docs.freebsd.org/en/books/handbook/zfs/#zfs-zfs)工具允许创建、销毁和管理数据集，包括[文件系统](https://docs.freebsd.org/en/books/handbook/zfs/#zfs-term-filesystem)和[卷](https://docs.freebsd.org/en/books/handbook/zfs/#zfs-term-volume)。

## 20.3.1. 创建和销毁存储池

创建一个 ZFS 存储池(zpool)需要永久性的决定，因为池的结构在创建后不能改变。最重要的决定是把物理磁盘分成哪种类型的 vdevs。关于可能的选项的细节，请看 [vdev 类型](https://docs.freebsd.org/en/books/handbook/zfs/#zfs-term-vdev)的列表。在创建池之后，大多数 vdev 类型不允许向 vdev 添加磁盘。镜像和条纹是例外，前者允许向 vdev 添加新的磁盘，后者通过将一个新的磁盘附加到 vdev 而升级到镜像。尽管添加新的 vdev 会扩大池子，但池子的布局在池子创建后不能改变。相反，备份数据，销毁池子，然后重新创建。

创建一个简单的镜像池：
```
# zpool create mypool mirror /dev/ada1 /dev/ada2
# zpool status
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada1    ONLINE       0     0     0
            ada2    ONLINE       0     0     0

errors: No known data errors
```
要用一条命令创建一个以上的 vdev，请指定由 vdev 类型关键字分隔的磁盘组，在这个例子中是`mirror`。
```
# zpool create mypool mirror /dev/ada1 /dev/ada2 mirror /dev/ada3 /dev/ada4
# zpool status
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada1    ONLINE       0     0     0
            ada2    ONLINE       0     0     0
          mirror-1  ONLINE       0     0     0
            ada3    ONLINE       0     0     0
            ada4    ONLINE       0     0     0

errors: No known data errors
```
池子也可以使用分区而不是整个磁盘。把 ZFS 放在一个单独的分区里，允许同一磁盘有其他的分区用于其他目的。特别是，它允许添加启动所需的引导码和文件系统的分区。这允许从也是一个池子的成员的磁盘上启动。当使用一个分区而不是整个磁盘时，ZFS 在 FreeBSD 上没有增加任何性能损失。使用分区还允许管理员对磁盘进行低配置，使用少于全部容量的磁盘。如果将来有一个与原来的名义大小相同的替换盘，实际的容量略小，那么较小的分区仍然适合，使用替换盘。

使用分区创建一个 [RAID-Z2](https://docs.freebsd.org/en/books/handbook/zfs/#zfs-term-vdev-raidz) 池：
```
# zpool create mypool raidz2 /dev/ada0p3 /dev/ada1p3 /dev/ada2p3 /dev/ada3p3 /dev/ada4p3 /dev/ada5p3
# zpool status
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          raidz2-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0
            ada4p3  ONLINE       0     0     0
            ada5p3  ONLINE       0     0     0

errors: No known data errors
```
销毁一个不再需要的池，以重新使用磁盘。销毁一个池子需要先解挂该池子中的文件系统。如果有任何数据集正在使用，解挂操作就会失败，而不会销毁这个池。用`-f`强制销毁池。这可能会导致在这些数据集上有已打开文件的应用程序的未定义行为。

## 20.3.2. 添加和删除设备

有两种方法可以将磁盘添加到 zpool 中：用`zpool attach`将磁盘附加到现有的 vdev 上，或者用`zpool add`将 vdev 添加到池中。有些 [vdev 类型](https://docs.freebsd.org/en/books/handbook/zfs/#zfs-term-vdev)允许在创建后向 vdev 添加磁盘。

用单个磁盘创建的池缺乏冗余性。它可以检测到损坏，但不能修复，因为没有其他的数据副本。[副本](https://docs.freebsd.org/en/books/handbook/zfs/#zfs-term-copies)属性可能能够从一个小的故障中恢复，如坏扇区，但不能提供与镜像或 RAID-Z 相同的保护水平。从一个由单个磁盘 vdev 组成的池开始，使用`zpool attach`向 vdev 添加一个新磁盘，创建一个镜像。也可以使用`zpool attach`向镜像组添加新的磁盘，增加冗余度和读取性能。当对用于池子的磁盘进行分区时，将第一个磁盘的布局复制到第二个磁盘上。使用`gpart backup`和`gpart restore`来使这个过程更容易。

通过连接 **ada1p3** 将单磁盘（stripe）vdev **ada0p3** 升级为镜像。
```
# zpool status
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          ada0p3    ONLINE       0     0     0

errors: No known data errors
# zpool attach mypool ada0p3 ada1p3
Make sure to wait until resilvering finishes before rebooting.

If you boot from pool 'mypool', you may need to update boot code on newly attached disk _ada1p3_.

Assuming you use GPT partitioning and _da0_ is your new boot disk you may use the following command:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0
# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1
bootcode written to ada1
# zpool status
  pool: mypool
 state: ONLINE
status: One or more devices is currently being resilvered.  The pool will
        continue to function, possibly in a degraded state.
action: Wait for the resilver to complete.
  scan: resilver in progress since Fri May 30 08:19:19 2014
        527M scanned out of 781M at 47.9M/s, 0h0m to go
        527M resilvered, 67.53% done
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0  (resilvering)

errors: No known data errors
# zpool status
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with 0 errors on Fri May 30 08:15:58 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors
```
当向现有的 vdev 添加磁盘不是一种选择，如 RAID-Z，另一种方法是向池中添加另一个 vdev。增加 vdevs 可以通过在 vdevs 上分配写操作而提供更高的性能。每个 vdev 都提供自己的冗余。混合 vdev 类型如镜像和 RAID-Z 是可能的，但不鼓励这样做。在一个包含镜像或 RAID-Z vdevs 的池中添加一个非冗余的 vdev，会给整个池的数据带来风险。分散写入意味着非冗余磁盘的故障将导致写入池中的每个块的一部分丢失。

ZFS 在每一个 vdevs 上进行数据条带化。例如，对于两个镜像 vdevs，这实际上是一个 RAID 10，它在两组镜像上进行条带化写入。ZFS 分配空间，使每个 vdev 在同一时间达到100%满载。拥有不同数量的可用空间的 vdev 将降低性能，因为更多的数据写入到未满的 vdev 上。

当把新设备连接到启动池时，记得要更新启动代码。

在现有的镜像上附加第二个镜像组（**ada2p3** 和 **ada3p3**）。
```
# zpool status
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with 0 errors on Fri May 30 08:19:35 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors
# zpool add mypool mirror ada2p3 ada3p3
# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2
bootcode written to ada2
# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada3
bootcode written to ada3
# zpool status
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
          mirror-1  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0

errors: No known data errors
```

如果有足够的剩余冗余，从池中移除 vdevs 是不可能的，而从镜像中移除磁盘是代价高昂的。如果在一个镜像组中只保留一个磁盘，该组就不再是一个镜像，而成为一个条带，如果剩余的磁盘发生故障，整个池就会有风险。

如需从三路镜像组中删除一个磁盘：

```
# zpool status
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0

errors: No known data errors
# zpool detach mypool ada2p3
# zpool status
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors
```