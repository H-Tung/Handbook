# 28.2. 配置 PPP

FreeBSD 为使用 [ppp(8)](https://www.freebsd.org/cgi/man.cgi?query=ppp&sektion=8&format=html) 管理拨号 PPP 连接提供了内置支持。默认的 FreeBSD 内核支持用于与调制解调器 (modem) 硬件交互的 tun 。通过编辑至少一个配置文件来进行配置，并且提供了包含实例的配置文件。最后，ppp 用于启动和管理连接。

为了使用 PPP 连接，需要准备：

- 一个互联网服务提供商（ISP）的拨号账户。

- 一个拨号调制解调器。

- ISP 的拨号号码。

- 由 ISP 分配的登录名和密码。

- 一个或多个 DNS 服务器的 IP 地址。通常情况下，ISP 会提供这些地址。如果没有，FreeBSD 可以自动配置 DNS 。


如果缺少任何所需的信息，请联系 ISP 。

以下信息可能由 ISP 提供，但不是必须的。

- 默认网关的 IP 地址。如果这个地址是未知的，ISP 会在连接设置时自动提供正确的值。在 FreeBSD 上配置 PPP 时，这个地址被称为 **HISADDR** 。

- 子网掩码。如果 ISP 没有提供，则在 [ppp(8)](https://www.freebsd.org/cgi/man.cgi?query=ppp&sektion=8&format=html) 配置文件中会使用 `255.255.255.255` 。

如果 ISP 已经分配了一个静态 IP 地址和主机名，请输入到配置文件中。否则，这些信息会在连接时使用默认配置。

本节的其余部分将演示如何根据常见的 PPP 连接情况配置 FreeBSD 。所需的配置文件是 **/etc/ppp/ppp.conf** ，其他文件和例子可以在 **/usr/share/examples/ppp/** 中找到。

> **注意**
> 
> 在这节中，所有作为例子展示的配置文件中都有行号。这些行号只是为了解释和讨论更方便，在实际文件中并不存在。
>
> 编辑配置文件时，适当的缩进很重要。首行使用 `:` 结尾，其余行使用空格或 `Tab` 缩进。

## 28.2.1基本配置

要配置 PPP 连接，首先根据 ISP 的拨号信息编辑 **/etc/ppp/ppp.conf** 。该文件描述如下：

```
default:
    set log Phase Chat LCP IPCP CCP tun command
    ident user-ppp VERSION
    set device /dev/cuau0
    set speed 115200
    set dial "ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 5 \
            \"\" AT OK-AT-OK ATE1Q0 OK \\dATDT\\T TIMEOUT 40 CONNECT"
    set timeout 180
    enable dns

provider:
    set phone "(123) 456 7890"
    set authname foo
    set authkey bar
    set timeout 300
    set ifaddr x.x.x.x/0 y.y.y.y/0 255.255.255.255 0.0.0.0
    add default HISADDR
```

**行 1：**

> 指定默认的项。 当PPP运行时这个项中的命令（第 2 行到第 9 行）将自动执行。

**行 2：**

> 启用登录参数。 工作正常后， 为避免产生过多的日志文件， 这行应该简化为：
> 
> ```
> set log phase tun
> ```

**行 3：**

> 显示连接另一端运行的 PPP 软件的 ppp(8) 版本。

**行 4：**

> 标明 modem (调制解调器) 要连接的端口号。COM1 对应的设备是 **/dev/cuau0** 而 COM2 对应的则是 **/dev/cuau1** 。

**行 5：**

> 设置连接速度。如果 115200 在较旧的调制解调器上不起作用，请尝试使用 38400 。

**行 6 & 7：**

> 拨号字符串写成期望发送的语法。有关详细信息，请参阅 [chat(8)](https://www.freebsd.org/cgi/man.cgi?query=chat&sektion=8&format=html) 。
> 
> 注意，为了便于阅读此命令进行了换行。任何 **ppp.conf** 里的命令都可以这样做，前提是行的最后一个字符必须是 `\` 。

**行 8：**

> 设置连接的时间间隔，单位是秒。

**行 9：**

> 告诉 PPP 向对方主机确认 DNS 解析设置。如果你运行了本地的 DNS 服务器，需要要注释或删除掉这一行。

**行 10：**

> 为了可读性的需要设置一个空行。PPP(8) 会忽略空行。

**行 11：**

> 为 **provider** 指定一个项。可以改成 ISP 的名字，这样你以后就可以使用 **load ISP** 来开启连接。

**行 12：**

> 设置提供商的电话号码。多个电话号码可以使用冒号 (:) 或管道符号 (|) 隔开。总的来讲，如果你要循环使用这些号码，可以使用冒号。如果你想使用第一个号码，当第一个号码失败了再用第二个号码，就使用管道符号。如所示的那样，要给整个电话号码加上引号(")。

**行 13 & 14：**

> ISP 的账号和密码

**行 15：**

> 设置默认的超时时间。这里，连接若在 300 秒内无响应将被断开。如果你不想设置成超时，将这个值设置成 0 。

**行 16：**

> 设置接口地址。使用的值取决于是从 ISP 获得静态 IP 地址，还是在连接期间协商动态 IP 地址。
>
> 如果 ISP 已经分配了一个静态 IP 地址和默认网关，用静态 IP 地址替换 `x.x.x.x` ，用默认网关的 IP 地址替换 `y.y.y.y` 。如果 ISP 只提供了一个静态 IP 地址而没有网关地址，则用 `10.0.0.2/0` 替换 `y.y.y.y.y` 。
>
> 如果在建立连接时 IP 地址发生变化，请将此行更改为以下值。这告诉 ppp(8) 使用 IP 配置协议 (IPCP) 来协商动态 IP 地址：
> 
> ```
> set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.255 0.0.0.0
> ```

**行 17：**

> 添加一个到 ISP 网关的默认路由。 **HISADDR** 这个关键字会被第 16 行所指定的网关地址替换。 这行必须出现在第 16 行之后，以免在 **HISADDR** 初始化之前使用它的值。

根据 ppp(8) 是手动还是自动启动，可能还需要创建一个 **/etc/ppp/ppp.linkup** ，其中包含以下几行。在 `-auto` 模式下运行 ppp 时，需要这个文件。这个文件在连接建立后使用。在这一点上，IP 地址已经被分配，现在可以添加路由表项。根据 ppp(8) 是手动还是自动启动，可能还需要创建一个 **/etc/ppp/ppp.linkup** ，其中包含以下几行。在 `-auto` 模式下运行 ppp 时需要这个文件。这个文件在连接建立后使用。在这一点上，IP 地址已经被分配，现在可以添加路由表项。在创建这个文件时，确保 **provider** 与 **ppp.conf** 第 11 行中显示的值一致：

```
provider:
      add default HISADDR
```

当静态 IP 地址配置中默认网关地址是 "猜到" 的，也需要这个文件。在这种情况下，从 **ppp.conf** 中删除第 17 行，用上述两行创建 **/etc/ppp/ppp.linkup** 。这个文件的更多例子可以在 **/usr/share/examples/ppp/** 中找到。

默认情况下，**ppp** 必须以 `root` 身份运行。要改变这个默认值，将运行 **ppp** 的用户的账户添加到 **/etc/group** 中的 `network` 组。

然后，给该用户允许访问 **/etc/ppp/ppp.conf** 中的一个或多个目录。例如，要让 **fred** 和 **mary** 只访问 `provider:` 项，在 `provider:` 部分添加这一行。

```
allow users fred mary
```

要让指定的用户访问所有目录，就把这一行放在默认部分。

## 28.2.2.高级配置